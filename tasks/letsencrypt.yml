

- apt: name=openssl update_cache=yes

- name: Generate RSA key
  command: openssl genrsa -out /etc/pki/cert/private/account.key 2048
    creates: /etc/pki/cert/private/account.key

- name: Generate CSR
  command: openssl req -new -sha256 -subj "{{ csr_fields }}" -key /etc/pki/cert/private/account.key -out /etc/pki/cert/csr/sample.com.csr
    creates: /etc/pki/cert/csr/sample.com.csr


- letsencrypt:
    account_key: /etc/pki/cert/private/account.key
    csr: /etc/pki/cert/csr/sample.com.csr
    dest: /etc/httpd/ssl/sample.com.crt
  register: sample_com_challenge

- debug: msg="csr submitted, sample challenge registered"
  when: sample_com_challenge|changed

- copy:
    dest: /var/www/html/{{ sample_com_challenge['challenge_data']['sample.com']['http-01']['resource'] }}
    content: "{{ sample_com_challenge['challenge_data']['sample.com']['http-01']['resource_value'] }}"
  when: sample_com_challenge|changed

- letsencrypt:
    account_key: /etc/pki/cert/private/account.key
    csr: /etc/pki/cert/csr/sample.com.csr
    dest: /etc/httpd/ssl/sample.com.crt
    data: "{{ sample_com_challenge }}"
  when: sample_com_challenge|changed

